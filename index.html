<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Votación Visual – Activación Lúdica</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --green:#00ff88;
  --blue:#00aaff;
}

*{box-sizing:border-box;margin:0;padding:0;}

body{
  min-height:100vh;
  background:radial-gradient(circle at top,#222,#000);
  color:white;
  font-family:'Segoe UI',Tahoma,sans-serif;

  display:grid;
  grid-template-rows:auto 1fr auto;
  align-items:center;
}

/* HEADER */
header{
  text-align:center;
  padding:20px 10px 10px;
}
header h1{
  font-size:2.2rem;
  letter-spacing:2px;
}
#timer{
  font-size:2.8rem;
  font-weight:900;
  letter-spacing:4px;
}

/* STAGE */
#stage{
  justify-self:center;
  width:520px;
  max-width:85vw;
  aspect-ratio:16/9;
  border-radius:18px;
  overflow:hidden;
  border:4px solid #333;
  box-shadow:0 0 30px rgba(0,0,0,.6);
  position:relative;
}
video{
  width:100%;
  height:100%;
  object-fit:cover;
  transform:scaleX(-1);
}
#overlay{
  position:absolute;
  inset:0;
  pointer-events:none;
}

/* FLASH */
.flash{
  position:absolute;
  inset:0;
  animation:flash .4s ease-out;
}
.flash.green{background:rgba(0,255,136,.35);}
.flash.blue{background:rgba(0,170,255,.35);}
@keyframes flash{from{opacity:1;}to{opacity:0;}}

/* UI */
#ui{
  width:100%;
  max-width:1100px;
  margin:25px auto 35px;
  padding:0 40px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:40px;
}
.option{
  background:rgba(255,255,255,.03);
  border-radius:22px;
  padding:24px 30px;
  text-align:center;
}
.label{
  font-size:2rem;
  font-weight:700;
}
.counter{
  font-size:4.6rem;
  font-weight:900;
  margin:10px 0;
}
.green{color:var(--green);}
.blue{color:var(--blue);}
.bar-bg{
  height:14px;
  border-radius:10px;
  background:#222;
  overflow:hidden;
}
.bar-fill{
  height:100%;
  transition:width .3s ease;
}
.bar-green{background:var(--green);}
.bar-blue{background:var(--blue);}

#status{
  text-align:center;
  font-size:.95rem;
  opacity:.7;
  margin-bottom:10px;
}
</style>
</head>

<body>

<header>
  <h1>¿CAMINO A o CAMINO B?</h1>
  <div id="timer">5</div>
</header>

<div id="stage">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" hidden></canvas>
  <div id="overlay"></div>
</div>

<section id="ui">
  <div class="option">
    <div class="label green">CAMINO A</div>
    <div id="greenVotes" class="counter green">0</div>
    <div class="bar-bg"><div id="barGreen" class="bar-fill bar-green"></div></div>
  </div>
  <div class="option">
    <div class="label blue">CAMINO B</div>
    <div id="blueVotes" class="counter blue">0</div>
    <div class="bar-bg"><div id="barBlue" class="bar-fill bar-blue"></div></div>
  </div>
</section>

<div id="status">Sistema activo · votación abierta</div>

<audio id="voteSound">
  <source src="data:audio/wav;base64,UklGRmQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YUAAAAA=">
</audio>

<script>
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d',{willReadFrequently:true});

const greenUI=document.getElementById('greenVotes');
const blueUI=document.getElementById('blueVotes');
const barGreen=document.getElementById('barGreen');
const barBlue=document.getElementById('barBlue');
const overlay=document.getElementById('overlay');
const timerUI=document.getElementById('timer');
const statusText=document.getElementById('status');

let timeLeft=99;
let votingActive=true;

/* CONFIG GRILLA */
const GRID_COLS=10;
const GRID_ROWS=6;
const CELL_THRESHOLD=120;

/* COLOR */
function rgbToHsl(r,g,b){
  r/=255; g/=255; b/=255;
  let max=Math.max(r,g,b), min=Math.min(r,g,b);
  let h,s,l=(max+min)/2;
  if(max===min){h=s=0;}
  else{
    let d=max-min;
    s=l>0.5?d/(2-max-min):d/(max+min);
    switch(max){
      case r:h=(g-b)/d+(g<b?6:0);break;
      case g:h=(b-r)/d+2;break;
      case b:h=(r-g)/d+4;break;
    }
    h*=60;
  }
  return[h,s*100,l*100];
}

function process(){
  if(video.readyState===video.HAVE_ENOUGH_DATA && votingActive){
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const img=ctx.getImageData(0,0,canvas.width,canvas.height).data;

    let greenCells=0;
    let blueCells=0;

    const cellW=Math.floor(canvas.width/GRID_COLS);
    const cellH=Math.floor(canvas.height/GRID_ROWS);

    for(let cy=0;cy<GRID_ROWS;cy++){
      for(let cx=0;cx<GRID_COLS;cx++){
        let g=0,b=0;
        for(let y=0;y<cellH;y+=4){
          for(let x=0;x<cellW;x+=4){
            const px=((cy*cellH+y)*canvas.width+(cx*cellW+x))*4;
            const[h,s,l]=rgbToHsl(img[px],img[px+1],img[px+2]);
            if(s>30 && l>20 && l<85){
              if(h>80 && h<160) g++;
              else if(h>180 && h<260) b++;
            }
          }
        }
        if(g>CELL_THRESHOLD && g>b) greenCells++;
        else if(b>CELL_THRESHOLD && b>g) blueCells++;
      }
    }

    greenUI.textContent=greenCells;
    blueUI.textContent=blueCells;

    const total=greenCells+blueCells;
    barGreen.style.width=total?(greenCells/total*100)+'%':'0%';
    barBlue.style.width=total?(blueCells/total*100)+'%':'0%';
  }
  requestAnimationFrame(process);
}

async function start(){
  const stream=await navigator.mediaDevices.getUserMedia({video:{width:640,height:480}});
  video.srcObject=stream;
  video.onloadedmetadata=()=>{
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    process();
  };
}

function countdown(){
  const i=setInterval(()=>{
    timeLeft--;
    timerUI.textContent=timeLeft>0?timeLeft:'STOP';
    if(timeLeft<=0){
      votingActive=false;
      statusText.textContent='Votación cerrada';
      clearInterval(i);
    }
  },1000);
}

start();
countdown();
</script>

</body>
</html>
