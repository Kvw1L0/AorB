<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Votación Visual TV Show</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
  --green: #00ff88;
  --red: #ff0055;
}

body {
  margin: 0;
  background: radial-gradient(circle at top, #222, #000);
  color: white;
  font-family: 'Segoe UI', Tahoma, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow: hidden;
}

h1 {
  margin: 20px 0 10px;
  letter-spacing: 2px;
}

#stage {
  position: relative;
  width: 80%;
  max-width: 900px;
  border: 6px solid #333;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 0 40px rgba(0,0,0,.7);
}

video {
  width: 100%;
  transform: scaleX(-1);
}

#overlay {
  position: absolute;
  inset: 0;
  pointer-events: none;
}

.flash {
  position: absolute;
  inset: 0;
  opacity: 0;
  animation: flash .4s ease-out;
}

.flash.green { background: rgba(0,255,136,.35); }
.flash.red { background: rgba(255,0,85,.35); }

@keyframes flash {
  from { opacity: 1; }
  to { opacity: 0; }
}

#ui {
  width: 90%;
  margin-top: 20px;
}

.option {
  margin-bottom: 20px;
}

.label {
  display: flex;
  justify-content: space-between;
  font-size: 1.8rem;
  font-weight: bold;
}

.counter {
  font-size: 2.2rem;
}

.bar-bg {
  height: 22px;
  background: #222;
  border-radius: 20px;
  overflow: hidden;
  margin-top: 6px;
}

.bar-fill {
  height: 100%;
  width: 0%;
}

.green { color: var(--green); }
.red { color: var(--red); }

.bar-green { background: var(--green); box-shadow: 0 0 15px var(--green); }
.bar-red { background: var(--red); box-shadow: 0 0 15px var(--red); }

#status {
  margin: 10px;
  font-size: 1rem;
  opacity: .7;
}

#timer {
  font-size: 3rem;
  margin: 10px;
  font-weight: bold;
  letter-spacing: 4px;
}
</style>
</head>

<body>

<h1>¿CAMINO A o CAMINO B?</h1>
<div id="timer">5</div>

<div id="stage">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" hidden></canvas>
  <div id="overlay"></div>
</div>

<div id="ui">
  <div class="option">
    <div class="label green">
      CAMINO A
      <span id="greenVotes" class="counter">0</span>
    </div>
    <div class="bar-bg">
      <div id="barGreen" class="bar-fill bar-green"></div>
    </div>
  </div>

  <div class="option">
    <div class="label red">
      CAMINO B
      <span id="redVotes" class="counter">0</span>
    </div>
    <div class="bar-bg">
      <div id="barRed" class="bar-fill bar-red"></div>
    </div>
  </div>
</div>

<div id="status">Inicializando sistema…</div>

<audio id="voteSound">
  <source src="data:audio/wav;base64,UklGRmQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YUAAAAA=">
</audio>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });

const greenUI = document.getElementById('greenVotes');
const redUI = document.getElementById('redVotes');
const barGreen = document.getElementById('barGreen');
const barRed = document.getElementById('barRed');
const statusText = document.getElementById('status');
const overlay = document.getElementById('overlay');
const sound = document.getElementById('voteSound');
const timerUI = document.getElementById('timer');

let greenVotes = 0;
let redVotes = 0;
let greenActive = false;
let redActive = false;

let votingActive = true;
let timeLeft = 5;

const GREEN_THRESHOLD = 150;
const RED_THRESHOLD = 150;
const SAMPLING = 10;

function rgbToHsl(r,g,b){
  r/=255; g/=255; b/=255;
  let max=Math.max(r,g,b), min=Math.min(r,g,b);
  let h,s,l=(max+min)/2;
  if(max===min){h=s=0;}
  else{
    let d=max-min;
    s=l>0.5?d/(2-max-min):d/(max+min);
    switch(max){
      case r:h=(g-b)/d+(g<b?6:0);break;
      case g:h=(b-r)/d+2;break;
      case b:h=(r-g)/d+4;break;
    }
    h*=60;
  }
  return [h,s*100,l*100];
}

function flash(color){
  const f = document.createElement('div');
  f.className = `flash ${color}`;
  overlay.appendChild(f);
  setTimeout(()=>f.remove(),400);
}

function vote(color){
  if(!votingActive) return;
  sound.currentTime = 0;
  sound.play();

  if(color==='green'){
    greenVotes++;
    greenUI.textContent = greenVotes;
    flash('green');
  } else {
    redVotes++;
    redUI.textContent = redVotes;
    flash('red');
  }

  const total = greenVotes + redVotes;
  barGreen.style.width = total ? (greenVotes/total*100)+'%' : '0%';
  barRed.style.width = total ? (redVotes/total*100)+'%' : '0%';
}

function process(){
  if(video.readyState === video.HAVE_ENOUGH_DATA){
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const data = ctx.getImageData(0,0,canvas.width,canvas.height).data;
    let g=0,r=0;

    for(let i=0;i<data.length;i+=4*SAMPLING){
      const [h,s,l] = rgbToHsl(data[i],data[i+1],data[i+2]);
      if(s>30 && l>20 && l<85){
        if(h>80 && h<160) g++;
        else if(h>330 || h<30) r++;
      }
    }

    if(g>GREEN_THRESHOLD && !greenActive){
      vote('green');
      greenActive=true;
    }
    if(g<=GREEN_THRESHOLD) greenActive=false;

    if(r>RED_THRESHOLD && !redActive){
      vote('red');
      redActive=true;
    }
    if(r<=RED_THRESHOLD) redActive=false;
  }
  requestAnimationFrame(process);
}

async function start(){
  const stream = await navigator.mediaDevices.getUserMedia({video:{width:640,height:480}});
  video.srcObject = stream;
  video.onloadedmetadata=()=>{
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    process();
  };
}

function countdown(){
  const interval=setInterval(()=>{
    timeLeft--;
    timerUI.textContent=timeLeft;
    if(timeLeft<=0){
      votingActive=false;
      timerUI.textContent="STOP";
      statusText.textContent="Votación cerrada";
      clearInterval(interval);
    }
  },1000);
}

statusText.textContent="Sistema activo – votación abierta";
start();
countdown();
</script>

</body>
</html>
